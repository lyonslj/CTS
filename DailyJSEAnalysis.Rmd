--- 

title: "LJL Analysis"
output: html_document
fig_width: 23
fig.align: "center"

---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(TTR)
library(quantmod)
library(reshape2)
library(plyr)
library(dplyr)
library(tidyr)
library(readxl)
library(reshape2)
library(DT)
library(plotly)
library(dygraphs)
library(data.table)
library(TTR)


source('~/Documents/Personal/DataScience/R/JL CTS scripts/DailyGraphNoPng.R')
source('~/Documents/Personal/DataScience/R/JL CTS scripts/WeeklyGraph.R')
source('~/Documents/Personal/DataScience/R/JL CTS scripts/RscHeatmap.R')
source('~/Documents/Personal/DataScience/R/JL CTS scripts/RelativeStrengthComparative.R')
source("/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/PLv2.R")
source("/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/CumRet.R")
source("/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/CumRetDyG.R")
source("/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/fnDyCumRet.R")
source("/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/fnLists.R")
source("/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/RelativeStrengthComparativeAllSegments.R")

##  ------------- Load data -----------------
##  ---------Previously Loaded data ---------

        JSEloaded_dat <- read.csv("/Users/johnlyons/Documents/Personal/DataScience/R/JSEdat.csv", header = TRUE, sep="")
        #                          stringsAsFactors = FALSE)
        ## -- Convert to correct format
        JSEloaded <- JSEloaded_dat
        JSEloaded$Date <- as.Date(JSEloaded$Date, "%Y-%m-%d")
        ## -- Check for last loaded date
        max(sort(JSEloaded$Date))
        JSEdat <- JSEloaded
        JSE.recent.dat <- JSEdat[JSEdat$Date >= Sys.Date()-450,]
        JSE.recent.dat <- unique(JSE.recent.dat[complete.cases(JSE.recent.dat),])
        cols <- 3:7
        JSE.recent.dat[, cols] <- apply(JSE.recent.dat[, cols], 2, as.numeric)
        
        list.of.i <- NULL
        df.daily.roc <- NULL
        df.weekly.roc <- NULL
        df.monthly.roc <- NULL


        # ----------- All lists of Indexes and data -------------------
        lists <- fnLists()
        excl_list <- lists$excl_list
        Indexes <- lists$Indexes
          

  # Function to process financial data efficiently
  # Process each instrument
  # filtering instruments with a monthly trading volume over 2,000,000. 
  # It converts data into daily, weekly, and monthly xts time-series objects, calculates daily and weekly ROC (Rate of Change) for closing    # prices, and stores results efficiently using data.table. Outputs include:instruments: Character vector of qualifying instrument names.
  # daily, monthly, weekly: Named lists of xts objects with OHLC and Volume data.
  # daily_roc, weekly_roc: Named lists of xts objects with ROC percentages.
  # daily_roc_df, weekly_roc_df: data.table objects with ROC values, dates, and instrument names, suitable for RscHeatmap.


 process_JSE_data <- function(JSE.recent.dat, excl_list = NULL, Indexes = NULL, 
                             volume_threshold = 2e6, min_daily = 30, min_weekly = 10) {
  # Input validation
  dt <- as.data.table(JSE.recent.dat)
  req_cols <- c("Name", "Date", "Open", "High", "Low", "Close", "Volume")
  if (!all(req_cols %in% names(dt))) stop("Required columns missing")
  if (!is.numeric(dt$Open) || !is.numeric(dt$High) || !is.numeric(dt$Low) || 
      !is.numeric(dt$Close) || !is.numeric(dt$Volume)) stop("Non-numeric data in OHLC/Volume")
  dt$Date <- as.Date(dt$Date)
  
  # Initialize output structures
  results <- list(
    instruments = character(),
    daily = list(),
    monthly = list(),
    weekly = list(),
    daily_roc = list(),
    weekly_roc = list(),
    daily_roc_df = data.table(Date = as.Date(character()), Close = numeric(), Insrm = character()),
    weekly_roc_df = data.table(Date = as.Date(character()), z.Close = numeric(), Insrm = character()),
    tbl_daily_roc = NULL,  # Matrix of daily ROC
    tbl_daily_R = NULL,    # Excluded daily ROC
    tbl_JseD_R = NULL      # Index-filtered daily ROC
  )
  
  # Group by instrument
  setkey(dt, Name)
  instruments <- unique(dt$Name)
  
  # Process each instrument
  for (i in instruments) {
    y <- dt[Name == i, .(Date, Open, High, Low, Close, Volume)]
    z <- xts(y[, .(Open, High, Low, Close, Volume)], order.by = y$Date)
    zm <- to.period(z, "months")
    
    last_month <- format(Sys.Date() %m-% 1, "%Y-%m")
    zm_mar <- zm[last_month]
    
    if (nrow(zm_mar) == 1 && as.numeric(zm_mar$z.Volume) > volume_threshold) {
      results$instruments <- c(results$instruments, i)
      results$monthly[[i]] <- zm
      results$daily[[i]] <- z
      zw <- to.period(z, "weeks")
      results$weekly[[i]] <- zw
      
      if (nrow(z) > min_daily && "Close" %in% colnames(z)) {
        roc <- round(ROC(z$Close, n = 1, type = "discrete") * 100, 2)
        results$daily_roc[[i]] <- roc
        i_tab <- data.table(Date = index(roc), Close = as.numeric(coredata(roc)), Insrm = i)
        results$daily_roc_df <- rbindlist(list(results$daily_roc_df, i_tab))
      }
      
      if (nrow(zw) > min_weekly && "z.Close" %in% colnames(zw)) {
        roc <- round(ROC(zw$z.Close, n = 1, type = "discrete") * 100, 2)
        results$weekly_roc[[i]] <- roc
        i_tab <- data.table(Date = index(roc), z.Close = as.numeric(coredata(roc)), Insrm = i)
        results$weekly_roc_df <- rbindlist(list(results$weekly_roc_df, i_tab))
      }
    }
  }
  
  # Process daily ROC into matrix and apply exclusions/filters
  if (nrow(results$daily_roc_df) > 0) {
    # Create matrix (similar to fnPrepData with "d" period, assuming daily reshape)
    results$tbl_daily_roc <- as.matrix(dcast(results$daily_roc_df, Date ~ Insrm, value.var = "Close"))
    
    # Set row names to Dates and remove Date column
    rownames(results$tbl_daily_roc) <- as.character(results$tbl_daily_roc[, "Date"])
    results$tbl_daily_roc <- results$tbl_daily_roc[, colnames(results$tbl_daily_roc) != "Date"]
    
    # Exclude instruments in excl_list
    if (!is.null(excl_list) && length(excl_list) > 0) {
      excl_pattern <- paste(excl_list, collapse = "|")
      results$tbl_daily_R <- results$tbl_daily_roc[, !grepl(excl_pattern, colnames(results$tbl_daily_roc)), drop = FALSE]
    } else {
      results$tbl_daily_R <- results$tbl_daily_roc
    }
    
    # Filter for Indexes
    if (!is.null(Indexes) && length(Indexes) > 0) {
      index_pattern <- paste(Indexes, collapse = "|")
      results$tbl_JseD_R <- results$tbl_daily_roc[, grepl(index_pattern, colnames(results$tbl_daily_roc)), drop = FALSE]
    } else {
      results$tbl_JseD_R <- matrix(nrow = nrow(results$tbl_daily_roc), ncol = 0)  # Empty matrix if no Indexes
    }
  }
  
  return(results)
}


## ------------------ Get rid NA's --------------------------
df.daily.roc <- na.omit(df.daily.roc)



## -- Prepare tables
## -- Function to calculate the ROC based on input, daily, weekly , monthly
fnPrepData <- function(dat,period) {
        ##colnames(dat)[2] <- "Close"
        tm.frame <- ifelse(period == "w", 100,
                           ifelse(period == "m", 450, 7))
        df.d.latest <- dat[dat$Date >= max(dat$Date)- tm.frame ,]
        colnames(df.d.latest)[1] <- "Date"
        dd <- spread(df.d.latest, Date, Close)
        lcol <- ncol(dd)
        dd$M <- round(apply(dd[,c(2:lcol)],1,mean),2)
        row.names(dd) <- dd$Insrm
        dd <- dd[,-1]
        dd[order(-dd$M),]
        
}


##      ---------------------   ##      ----------------------  #
##                      Datatable

my_palette <- colorRampPalette(c("red", "yellow", "green"))(n = 301)
col_breaks <- c(seq(-10, -5, length = 60),  # for red
                seq(-4, 0, length = 60),    # for yellow
                seq(1, 5, length = 60),     # for yellow
                seq(6, 10, length = 60),    # for yellow
                seq(11, 30, length = 60))   # for green

# Function (unchanged, but note the substr issue)
fnRocTable <- function(dat.roc, x) { 
  colnames(dat.roc) <- substr(names(dat.roc), 6, 10)
  colnames(dat.roc)[ncol(dat.roc)] <- "Mean"
  DT::datatable(dat.roc, caption = x, 
                class = 'cell-border stripe', 
                rownames = TRUE, 
                editable = TRUE, 
                options = list(dom = "Bfrtip",
                               pageLength = 50, 
                               autoWidth = TRUE)) %>%          
    formatStyle(columns = c(0:ncol(dat.roc)), 
                fontSize = '60%',
                backgroundColor = styleInterval(col_breaks, my_palette))
}





##      -------------------------------------------------------         ##
##                              Live Trades                             ##
##      -------------------------------------------------------         ##

##--fix

#Trades <- read_excel("/Users/johnlyons/Dropbox/CTS/Trades.xlsx",
#                     col_names = TRUE,na = "")
#Trades <- as.data.frame(Trades)
#Trades$Purchase <- as.Date(Trades$Purchase)
#Trades$`Exit Dt` <- as.Date(Trades$`Exit Dt`)
#mylst <- subset(Trades,is.na(Trades$Exit)) 
#instLive <- as.character(sort(mylst[,1]))

##      -------------------------------------------------------         ##
##                              Commodities                             ##
##      -------------------------------------------------------         ##
commods <- lists$Commods
fnJunk <- function(variables) {
}




```


## Market Analysis  {.tabset .tabset-fade .tabset-pills}

### Trading Plan

* Your trading objective is to make money, not to lose it. The losses kill you
* Thats how you make money and not compromise your capital
* Trade mechanically - Follow The Rules
* The key is not where to Enter, but where to Exit
* Trade according to RSC heatmap
* Exit
+ Close below 4hr Kaufman Adaptive MA
+ and / or confirmed by RSC heatmap change
* Do not chase gains if these two conditions have been vioalted - FTR

##### All neg R > -1 except 2

![Alt text](/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/Bad1.png)![Alt text](/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/Bad2.gif)

![Alt text](/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/Bad3.gif)![Alt text](/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/Bad4.gif)

![Alt text](/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/Bad5.gif)![Alt text](/Users/johnlyons/Documents/Personal/DataScience/R/JL CTS scripts/Bad6.gif)





### Indexes

```{r, fig.width=14,  fig.height= 8, message= FALSE, warning=FALSE, echo = FALSE, silent = TRUE}   

lst <- lists$RESI
RSC(lst,"RESI",to_console = FALSE)
CumRet(lst)

```


